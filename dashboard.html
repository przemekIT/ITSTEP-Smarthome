{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>SmartKey - Panel Sterowania</title>

    <!--  Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body { background-color: #f7f9fc; }
        .card { border-radius: 15px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .navbar-brand { font-weight: bold; }
    </style>
</head>
<body>

<!-- Pasek nawigacyjny wspolny dla calej aplikacji -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">SmartKey</a>
        <div class="d-flex">
            <!-- Odnosniki do glownych modulow systemu -->
            <a class="btn btn-outline-light me-2" href="/settings/">Ustawienia</a>
            <a class="btn btn-outline-light me-2" href="/">Dashboard</a>
            <a class="btn btn-outline-light me-2" href="/devices/">Urządzenia</a>
            <a class="btn btn-outline-light me-2" href="/rules/">Reguly</a>
            <a class="btn btn-outline-light" href="/admin/">Admin</a>
        </div>
    </div>
</nav>

<div class="container">
    <!-- Naglowek glowny dashboardu -->
    <h2 class="text-center mb-4 text-primary">Panel Sterowania SmartKey</h2>

    <!--  Karty statystyk – pokazuja zbiorcze informacje o urzadzeniach -->
    <div class="row text-center mb-4">
        <div class="col-md-4">
            <div class="card p-3 bg-light">
                <h4>Suma urządzeń</h4>
                <h2 class="text-primary">{{ total_devices }}</h2>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 bg-light">
                <h4>Aktywne urządzenia</h4>
                <h2 class="text-success">{{ active_devices }}</h2>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 bg-light">
                <h4>Nieaktywne</h4>
                <h2 class="text-danger">{{ inactive_devices }}</h2>
            </div>
        </div>
    </div>

    <!--  Dane czujnikow – tabela wszystkich urzadzen typu "sensor" -->
    <div class="card p-3 mb-4">
        <h4 class="mb-3">Dane czujników</h4>
        {% if sensors %}
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Nazwa</th>
                        <th>Pokój</th>
                        <th>Wartość</th>
                        <th>Ostatnia aktualizacja</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in sensors %}
                    <tr>
                        <td>{{ s.name }}</td>
                        <td>{{ s.room }}</td>
                        <td>{{ s.value|default:"—" }}</td>
                        <td>{{ s.last_updated|date:"d/m/Y H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <!-- Komunikat, gdy nie ma zadnych czujnikow w systemie -->
            <div class="alert alert-info">
                Zaden czujnik nie jest jeszcze skonfigurowany.
            </div>
        {% endif %}
    </div>

    <!-- Wykres Plotly z wyborem czujnika -->
    <div class="card p-3 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Historia czujnika</h4>

            <!-- Formularz GET do wyboru czujnika -->
            <form method="get" class="d-flex">

                <!-- Lista czujnikow do wyboru -->
                <select name="sensor" class="form-select me-2">
                    {% for s in sensors %}
                        <option value="{{ s.id }}" {% if selected_sensor and selected_sensor.id == s.id %}selected{% endif %}>
                            {{ s.name }} ({{ s.room }})
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">Pokaż</button>
            </form>
        </div>

        {% if selected_sensor and readings %}
            <!-- Informacja ktory czujnik jest aktualnie wyswietlany -->
            <p class="mb-3">Wyświetlany czujnik: <strong>{{ selected_sensor.name }}</strong></p>
            <!-- Kontener, w ktorym Plotly narysuje wykres -->
            <div id="sensorChart"></div> 
        {% else %}
            <!-- Komunikat w przypadku braku danych historycznych -->
            <div class="alert alert-info">
                Brak danych historycznych dla wybranego czujnika.
            </div>
        {% endif %}
    </div>

    <!--  Linki szybkie -->
    <div class="text-center">
        <a href="/devices/" class="btn btn-primary me-2">Urządzenia</a>
        <a href="/rules/" class="btn btn-secondary me-2">Reguly</a>
        <a href="/admin/" class="btn btn-dark">Administracja</a>
    </div>
</div>

<footer class="text-center mt-5 mb-3 text-muted">
    <small>Projekt SmartKey - Symulacja bez MQTT</small>
</footer>

<!-- debug: ile odczytow -->
<p class="text-muted">
    Liczba odczytów dla wybranego czujnika: {{ readings|length }}
</p>

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

{% if selected_sensor and readings %}
<script>
    // dane czasowe (linia X) z SensorData
    const timestamps = [
        {% for r in readings %}
            "{{ r.timestamp|date:'Y-m-d H:i:s' }}",
        {% endfor %}
    ];

    // wartosci pomiarów (linia Y)
    const values = [
        {% for r in readings %}
            {{ r.value }},
        {% endfor %}
    ];

    // Dane do wykresu – jedna seria (linia + punkty)
    const data = [{
        x: timestamps,
        y: values,
        mode: 'lines+markers',
        name: '{{ selected_sensor.name }}'
    }];

    // Ustawienia wygladu wykresu
    const layout = {
        title: 'Historia: {{ selected_sensor.name }}',
        xaxis: { title: 'Czas' },
        yaxis: { title: 'Wartość' }
    };

    // Rysowanie wykresu w elemencie o id "sensorChart"
    Plotly.newPlot('sensorChart', data, layout);
</script>
{% endif %}

</body>
</html>
